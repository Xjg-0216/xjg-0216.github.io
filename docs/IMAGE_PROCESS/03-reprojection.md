
# é€å°„å˜æ¢ä¸é‡æŠ•å½±

### é€å°„å˜æ¢

é€å°„å˜æ¢æ˜¯æŒ‡åœ¨2Då›¾åƒä¸­å°†ä¸€ä¸ªå¹³é¢å˜æ¢åˆ°å¦ä¸€ä¸ªå¹³é¢çš„è¿‡ç¨‹ã€‚è¿™ç§å˜æ¢å¯ä»¥é€šè¿‡ä¸€ä¸ª3x3çš„çŸ©é˜µæ¥è¡¨ç¤ºï¼Œé€‚ç”¨äºå››ä¸ªç‚¹çš„åŒ¹é…ã€‚è¿™ç§å˜æ¢å¸¸ç”¨äºå›¾åƒé…å‡†ã€å›¾åƒæ‹¼æ¥ç­‰åº”ç”¨åœºæ™¯ã€‚é€å°„å˜æ¢å¯ä»¥å¤„ç†æ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ä»¥åŠé€è§†å˜å½¢ã€‚


é€å°„å˜æ¢å¯ä»¥è¡¨ç¤ºä¸ºå¦‚ä¸‹å½¢å¼ï¼š

$\begin{pmatrix} x' \\ y' \\ w' \end{pmatrix} = \begin{pmatrix} h_{11} & h_{12} & h_{13} \\ h_{21} & h_{22} & h_{23} \\ h_{31} & h_{32} & h_{33} \end{pmatrix} \begin{pmatrix} x \\ y \\ 1 \end{pmatrix}$

å…¶ä¸­ï¼š

-   $(x, y)$ æ˜¯åŸå›¾åƒä¸­çš„ç‚¹ã€‚
-   $(x', y')$ æ˜¯ç›®æ ‡å›¾åƒä¸­çš„ç‚¹ã€‚
-   $H$ æ˜¯ 3x3 çš„é€å°„å˜æ¢çŸ©é˜µï¼ŒåŒ…å«9ä¸ªå‚æ•° $h_{ij}$ã€‚
-   $w'$ æ˜¯ä¸€ä¸ªå½’ä¸€åŒ–å› å­ã€‚

ä¸ºäº†å¾—åˆ°æœ€ç»ˆçš„å›¾åƒåæ ‡ $(x', y')$ï¼Œéœ€è¦è¿›è¡Œå½’ä¸€åŒ–ï¼š

$x' = \frac{h_{11}x + h_{12}y + h_{13}}{h_{31}x + h_{32}y + h_{33}}$ ï¼Œ$y' = \frac{h_{21}x + h_{22}y + h_{23}}{h_{31}x + h_{32}y + h_{33}}$

#### æ±‚è§£é€å°„å˜æ¢çŸ©é˜µ

ä¸ºäº†è®¡ç®—é€å°„å˜æ¢çŸ©é˜µ $H$ï¼Œæˆ‘ä»¬éœ€è¦è‡³å°‘å››å¯¹å¯¹åº”ç‚¹ $(x_i, y_i)$ å’Œ $(x'_i, y'_i)$ï¼Œç„¶åé€šè¿‡è¿™äº›ç‚¹æ¥æ±‚è§£ $H$ã€‚ä¸‹é¢æ˜¯æ±‚è§£ $H$ çš„æ­¥éª¤ï¼š

1.  **æ„å»ºçº¿æ€§æ–¹ç¨‹ç»„**ï¼š å¯¹äºæ¯ä¸€å¯¹ç‚¹ $(x_i, y_i)$ å’Œ $(x'_i, y'_i)$ï¼Œå¯ä»¥å¾—åˆ°ä¸¤ä¸ªçº¿æ€§æ–¹ç¨‹ï¼š
    
    $\begin{cases} h_{11}x_i + h_{12}y_i + h_{13} - h_{31}x_ix'_i - h_{32}y_ix'_i - h_{33}x'_i = 0 \\ h_{21}x_i + h_{22}y_i + h_{23} - h_{31}x_iy'_i - h_{32}y_iy'_i - h_{33}y'_i = 0 \end{cases}$
2.  **æ„å»ºçŸ©é˜µæ–¹ç¨‹**ï¼š å°†ä¸Šé¢çš„æ–¹ç¨‹ç»„è½¬æ¢ä¸ºçŸ©é˜µå½¢å¼ $A\vec{h} = 0$ï¼Œå…¶ä¸­ $A$ æ˜¯ 2n x 9 çš„çŸ©é˜µï¼Œ$\vec{h}$ æ˜¯åŒ…å« $h_{ij}$ çš„åˆ—å‘é‡ï¼š
    
    $A = \begin{pmatrix} x_1 & y_1 & 1 & 0 & 0 & 0 & -x_1x'_1 & -y_1x'_1 & -x'_1 \\ 0 & 0 & 0 & x_1 & y_1 & 1 & -x_1y'_1 & -y_1y'_1 & -y'_1 \\ \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\ x_n & y_n & 1 & 0 & 0 & 0 & -x_nx'_n & -y_nx'_n & -x'_n \\ 0 & 0 & 0 & x_n & y_n & 1 & -x_ny'_n & -y_ny'_n & -y'_n \end{pmatrix}$
3.  **æ±‚è§£æ–¹ç¨‹**ï¼š ä½¿ç”¨å¥‡å¼‚å€¼åˆ†è§£ï¼ˆSVDï¼‰æ±‚è§£ $A\vec{h} = 0$ çš„æœ€å°äºŒä¹˜è§£ã€‚




ä»¥ä¸‹é¢ä»£ç ä¸¾ä¾‹
```python
import cv2
import numpy as np
import matplotlib.pyplot as plt

# ç”Ÿæˆä¸€ä¸ªç¤ºä¾‹å›¾åƒ (640x512)ï¼Œå¯ä»¥æ›¿æ¢ä¸ºå®é™…å›¾åƒè¯»å–
image = np.zeros((512, 640, 3), dtype=np.uint8)
cv2.rectangle(image, (150, 100), (500, 400), (255, 255, 255), -1)  # ç”»ä¸€ä¸ªç™½è‰²çŸ©å½¢

# å®šä¹‰åŸå›¾åƒä¸­çš„å››ä¸ªç‚¹ï¼ˆä¾‹å¦‚ï¼ŒçŸ©å½¢çš„å››ä¸ªè§’ï¼‰
pts_src = np.array([[150, 100], [500, 100], [500, 400], [150, 400]])

# å®šä¹‰ç›®æ ‡å›¾åƒä¸­çš„å››ä¸ªç‚¹ï¼ˆå°†çŸ©å½¢å˜å½¢ä¸ºä»»æ„å››è¾¹å½¢ï¼‰
pts_dst = np.array([[100, 50], [540, 80], [500, 460], [140, 480]])

# è®¡ç®—é€å°„å˜æ¢çŸ©é˜µ
h, status = cv2.findHomography(pts_src, pts_dst)

# ä½¿ç”¨é€å°„å˜æ¢çŸ©é˜µå¯¹å›¾åƒè¿›è¡Œå˜æ¢
im_out = cv2.warpPerspective(image, h, (640, 512))

# æ˜¾ç¤ºåŸå›¾åƒå’Œå˜æ¢åçš„å›¾åƒ
plt.figure(figsize=(12, 6))
plt.subplot(121)
plt.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
plt.title('Original Image')

plt.subplot(122)
plt.imshow(cv2.cvtColor(im_out, cv2.COLOR_BGR2RGB))
plt.title('Warped Image')

plt.show()

```


![alt text](./img/image.png)


### é‡æŠ•å½±

é‡æŠ•å½±åˆ™æ˜¯æŒ‡å°†ä¸‰ç»´ç‚¹é€šè¿‡æŠ•å½±çŸ©é˜µæŠ•å½±åˆ°äºŒç»´å›¾åƒå¹³é¢ä¸Šã€‚é‡æŠ•å½±è¯¯å·®å¸¸ç”¨æ¥è¯„ä¼°ä¸‰ç»´é‡å»ºæˆ–ç›¸æœºæ ¡å‡†çš„ç²¾åº¦ï¼Œè®¡ç®—æ–¹å¼æ˜¯å°†3Dç‚¹æŠ•å½±åˆ°å›¾åƒå¹³é¢ä¸Šï¼Œç„¶åä¸å®é™…å›¾åƒç‚¹è¿›è¡Œæ¯”è¾ƒã€‚


#### é‡æŠ•å½±çš„æ•°å­¦å…¬å¼

é‡æŠ•å½±å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š

1.  **ä»ä¸‰ç»´ç‚¹åˆ°äºŒç»´ç‚¹çš„æŠ•å½±**ï¼š

$\begin{pmatrix} u \\ v \\ 1 \end{pmatrix} = \begin{pmatrix} f_x & 0 & c_x \\ 0 & f_y & c_y \\ 0 & 0 & 1 \end{pmatrix} \begin{pmatrix} X / Z \\ Y / Z \\ 1 \end{pmatrix}$

å…¶ä¸­ï¼š

-   $(X, Y, Z)$ æ˜¯ä¸‰ç»´ç‚¹çš„åæ ‡ã€‚
-   $(u, v)$ æ˜¯æŠ•å½±åˆ°å›¾åƒå¹³é¢ä¸Šçš„äºŒç»´ç‚¹åæ ‡ã€‚
-   $f_x$ å’Œ $f_y$ æ˜¯ç„¦è·ã€‚
-   $(c_x, c_y)$ æ˜¯å›¾åƒçš„ä¸»ç‚¹ï¼ˆå…‰å­¦ä¸­å¿ƒï¼‰ã€‚

2.  **å½’ä¸€åŒ–**ï¼š

ä¸ºäº†å¾—åˆ°æœ€ç»ˆçš„å›¾åƒåæ ‡ $(u, v)$ï¼Œéœ€è¦è¿›è¡Œå½’ä¸€åŒ–ï¼š

$u = \frac{X \cdot f_x}{Z} + c_x$ ï¼Œ$v = \frac{Y \cdot f_y}{Z} + c_y$

### è®¡ç®—é‡æŠ•å½±è¯¯å·®

é‡æŠ•å½±è¯¯å·®æ˜¯è¡¡é‡æ¨¡å‹ç²¾åº¦çš„ä¸€ä¸ªæŒ‡æ ‡ï¼Œè®¡ç®—æ–¹æ³•æ˜¯å°†ä¸‰ç»´ç‚¹é€šè¿‡ç›¸æœºæŠ•å½±çŸ©é˜µæŠ•å½±åˆ°äºŒç»´å›¾åƒå¹³é¢ï¼Œç„¶åä¸å®é™…çš„äºŒç»´å›¾åƒç‚¹è¿›è¡Œæ¯”è¾ƒï¼š

$\text{error} = \sqrt{(u - u')^2 + (v - v')^2}$

å…¶ä¸­ï¼š

-   $(u, v)$ æ˜¯å®é™…å›¾åƒä¸­çš„äºŒç»´ç‚¹ã€‚
-   $(u', v')$ æ˜¯é€šè¿‡é‡æŠ•å½±è®¡ç®—å¾—åˆ°çš„äºŒç»´ç‚¹ã€‚

#### 1. ç›¸æœºæŠ•å½±çŸ©é˜µè®¡ç®—
ç›¸æœºæŠ•å½±çŸ©é˜µ ğ‘ƒæ˜¯é€šè¿‡ç›¸æœºå†…å‚çŸ©é˜µ ğ¾å’Œå¤–å‚ï¼ˆæ—‹è½¬çŸ©é˜µğ‘…å’Œå¹³ç§»å‘é‡ ğ‘¡è®¡ç®—å¾—åˆ°çš„ã€‚


##### ç›¸æœºå†…å‚çŸ©é˜µ 

\[ K = \begin{pmatrix}
    f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1
\end{pmatrix} \]
##### æ—‹è½¬çŸ©é˜µ \( R \):
æ—‹è½¬çŸ©é˜µ \( R \) æ˜¯ç”±ä¸‰ä¸ªæ—‹è½¬çŸ©é˜µï¼ˆç»• Z è½´çš„åèˆªè§’ \( \theta_z \)ï¼Œç»• Y è½´çš„ä¿¯ä»°è§’ \( \theta_y \)ï¼Œç»• X è½´çš„æ»šè½¬è§’ \( \theta_x \)ï¼‰ç»„æˆçš„ï¼š  

\[ R = R_z(\theta_z) \cdot R_y(\theta_y) \cdot R_x(\theta_x) \]  

å…¶ä¸­ï¼š  

\[ R_z(\theta_z) = \begin{pmatrix}
\cos(\theta_z) & -\sin(\theta_z) & 0 \\
\sin(\theta_z) & \cos(\theta_z) & 0 \\
0 & 0 & 1
\end{pmatrix} \]  

\[ R_y(\theta_y) = \begin{pmatrix}
\cos(\theta_y) & 0 & \sin(\theta_y) \\
0 & 1 & 0 \\
-\sin(\theta_y) & 0 & \cos(\theta_y)
\end{pmatrix} \]  

\[ R_x(\theta_x) = \begin{pmatrix}
1 & 0 & 0 \\
0 & \cos(\theta_x) & -\sin(\theta_x) \\
0 & \sin(\theta_x) & \cos(\theta_x)
\end{pmatrix} \]  

##### å¹³ç§»å‘é‡ \( t \):  

\[ t = \begin{pmatrix}
t_x \\
t_y \\
t_z
\end{pmatrix} \]  

##### æŠ•å½±çŸ©é˜µ \( P \):  

\[ P = K \cdot [R | t] \]  

#### 2. å›¾åƒåæ ‡åˆ°åœ°é¢åæ ‡çš„è½¬æ¢  

å¯¹äºæ¯ä¸ªå›¾åƒåƒç´ åæ ‡ \( (u, v) \)ï¼Œå¯ä»¥è®¡ç®—å…¶åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä¸‰ç»´ç‚¹ \( (X, Y, Z) \)ï¼š  

\[ \begin{pmatrix}
X \\
Y \\
Z \\
1
\end{pmatrix} = P_{\text{inv}} \cdot \begin{pmatrix}
u \\
v \\
1
\end{pmatrix} \]  

å…¶ä¸­ \( P_{\text{inv}} \) æ˜¯æŠ•å½±çŸ©é˜µçš„ä¼ªé€†çŸ©é˜µã€‚
#### 3. ä½¿ç”¨åœ°é¢é«˜ç¨‹è¿›è¡Œå½’ä¸€åŒ–
å‡è®¾åœ°é¢é«˜ç¨‹ä¸º \( Z = H \)ï¼Œåˆ™ï¼š  

\[ \begin{pmatrix}
X' \\
Y' \\
H \\
1
\end{pmatrix} = \frac{H}{Z} \cdot \begin{pmatrix}
X \\
Y \\
Z \\
1
\end{pmatrix} \]

#### 4. åœ°é¢åæ ‡æ˜ å°„åˆ°æ­£å°„å›¾åƒ  

å°†åœ°é¢åæ ‡ \( (X', Y') \) æ˜ å°„åˆ°æ­£å°„å›¾åƒåæ ‡ \( (u', v') \)ï¼š  

\[ u' = \frac{X'}{\Delta X} + u_0 \]  

\[ v' = \frac{Y'}{\Delta Y} + v_0 \]  

å…¶ä¸­ \( \Delta X \) å’Œ \( \Delta Y \) æ˜¯åœ°é¢åæ ‡åˆ°åƒç´ åæ ‡çš„æ¯”ä¾‹å› å­ï¼Œ\( (u_0, v_0) \) æ˜¯æ­£å°„å›¾åƒçš„ä¸­å¿ƒåæ ‡ã€‚